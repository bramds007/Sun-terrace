<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SunTerras â€” Amsterdam</title>
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif}
    header{padding:10px 12px;border-bottom:1px solid #eee;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    #map{position:absolute;inset:72px 0 0 0}
    .badge{padding:4px 8px;border-radius:999px;background:#f5f5f5}
    .btn{padding:6px 10px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer}
  </style>
</head>
<body>
<header>
  <strong>SunTerras â€” AMS</strong>
  <span class="badge" id="info">Ladenâ€¦</span>
  <span class="badge" id="dataBadge">Data: ?</span>

  <label>Tijd: <input id="time" type="time" step="300" /></label>
  <label>Datum: <input id="date" type="date" /></label>
  <label><input id="onlySunny" type="checkbox" /> alleen zon</label>
  <button class="btn" id="btnNow">Nu</button>
  <span class="badge" id="sunBadge">Zon: â€¦</span>
</header>
<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<script>
/* ===== Zonstand (robuust) ===== */
function toRad(d){return d*Math.PI/180} function toDeg(r){return r*180/Math.PI}
function getJulian(date){return date/86400000 - date.getTimezoneOffset()/1440 + 2440587.5}
function solarMeanAnomaly(d){return toRad(357.5291 + 0.98560028*(d-2451545))}
function eclipticLongitude(M){const C=toRad(1.9148)*Math.sin(M)+toRad(0.02)*Math.sin(2*M)+toRad(0.0003)*Math.sin(3*M);const P=toRad(102.9372);return M+C+P+Math.PI;}
function sunCoords(d){const M=solarMeanAnomaly(d),L=eclipticLongitude(M),e=toRad(23.4397);return{dec:Math.asin(Math.sin(e)*Math.sin(L)),ra:Math.atan2(Math.cos(e)*Math.sin(L),Math.cos(L))};}
function siderealTime(d,lw){return toRad((280.16+360.9856235*(d-2451545)))-lw;}
function sunPosition(date, lat, lon){const lw=toRad(-lon),phi=toRad(lat),d=getJulian(date)-2451545,c=sunCoords(d);const H=siderealTime(getJulian(date),lw)-c.ra;const alt=Math.asin(Math.sin(phi)*Math.sin(c.dec)+Math.cos(phi)*Math.cos(c.dec)*Math.cos(H));const az=Math.atan2(Math.sin(H),Math.cos(H)*Math.sin(phi)-Math.tan(c.dec)*Math.cos(phi));return{altitude:toDeg(alt),azimuth:(toDeg(az)+180+360)%360};}

/* ===== App state ===== */
const AMS={lat:52.370216,lon:4.895168};
const AMS_BBOX='4.75,52.30,5.02,52.42';     // fallback-bbox (heel Amsterdam)
const STATE={date:new Date(),onlySunny:false,altThreshold:2.0};
let TERR_POLY=null,TERR_PTS=null,BUILDINGS=null;

/* ===== Kaart ===== */
const map=new maplibregl.Map({
  container:'map',
  style:{version:8,
    sources:{osm:{type:'raster',tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],tileSize:256,attribution:'Â© OpenStreetMap'}},
    layers:[{id:'osm',type:'raster',source:'osm'}]},
  center:[AMS.lon,AMS.lat],zoom:13
});
map.addControl(new maplibregl.NavigationControl());

function bboxFromMap(){const b=map.getBounds();return [b.getWest(),b.getSouth(),b.getEast(),b.getNorth()];}

map.on('load', async ()=>{
  setupControls();
  await refreshData();
  renderLayers();
  computeAndApplySun();
  let t; map.on('moveend', ()=>{clearTimeout(t);t=setTimeout(async()=>{await refreshData(); computeAndApplySun();},150);});
});

/* ===== Data ophalen met fallback-bbox & debug ===== */
async function refreshData(){
  const badge=document.getElementById('dataBadge');
  const info=document.getElementById('info');

  // 1) Probeer met huidige viewport-bbox
  const bboxNow=bboxFromMap().join(',');
  let tr = await fetch(`/api/terraces?bbox=${bboxNow}`);
  let tj;
  try { tj = await tr.json(); } catch { tj = null; }

  // 2) Fallback naar vaste Amsterdam-bbox als er niets is
  const noTerr = !tj || ((!tj.terracePolys || tj.terracePolys.features.length===0) &&
                         (!tj.placePoints  || tj.placePoints.features.length===0));
  if (noTerr){
    const tr2 = await fetch(`/api/terraces?bbox=${AMS_BBOX}`);
    try { tj = await tr2.json(); info.textContent='Fallback AMS-bbox gebruikt'; }
    catch { tj = { terracePolys:{type:'FeatureCollection',features:[]}, placePoints:{type:'FeatureCollection',features:[]} }; info.textContent='Geen data'; }
  } else {
    info.textContent='OK';
  }

  TERR_POLY = tj?.terracePolys || { type:'FeatureCollection', features:[] };
  TERR_PTS  = tj?.placePoints  || { type:'FeatureCollection', features:[] };

  // Gebouwen (niet blokkerend; als t faalt, gewoon leeg laten)
  let bj=null;
  try{
    const br = await fetch(`/api/buildings?bbox=${bboxNow}`);
    bj = await br.json();
  }catch{}
  BUILDINGS = (bj && bj.buildings) ? bj.buildings : { type:'FeatureCollection', features:[] };

  const polyN=TERR_POLY.features.length, ptN=TERR_PTS.features.length, bN=BUILDINGS.features.length;
  if (badge) badge.textContent=`BBOX: ${bboxNow} â€¢ Poly ${polyN}, Pt ${ptN} â€¢ Bdg ${bN}`;
}

/* ===== Lagen ===== */
function renderLayers(){
  const has=id=>!!map.getSource(id);
  if(!has('terr-polys')) map.addSource('terr-polys',{type:'geojson',data:TERR_POLY,promoteId:'id'}); else map.getSource('terr-polys').setData(TERR_POLY);
  if(!has('terr-points')) map.addSource('terr-points',{type:'geojson',data:TERR_PTS,promoteId:'id'}); else map.getSource('terr-points').setData(TERR_PTS);
  if(!has('buildings')) map.addSource('buildings',{type:'geojson',data:BUILDINGS}); else map.getSource('buildings').setData(BUILDINGS);

  if(!map.getLayer('terr-fill')) map.addLayer({id:'terr-fill',type:'fill',source:'terr-polys',
    paint:{'fill-color':['case',['boolean',['feature-state','sunny'],false],'#22c55e','#cbd5e1'],'fill-opacity':0.6}});
  if(!map.getLayer('terr-outline')) map.addLayer({id:'terr-outline',type:'line',source:'terr-polys',paint:{'line-color':'#111','line-width':1}});
  if(!map.getLayer('terr-points')) map.addLayer({id:'terr-points',type:'circle',source:'terr-points',
    paint:{'circle-color':['case',['boolean',['feature-state','sunny'],false],'#22c55e','#cbd5e1'],'circle-radius':6,'circle-stroke-width':1,'circle-stroke-color':'#111'}});
  if(!map.getLayer('terr-label-polys')) map.addLayer({id:'terr-label-polys',type:'symbol',source:'terr-polys',
    layout:{'text-field':['get','name'],'text-size':11,'text-offset':[0,1.0],'text-anchor':'top'},paint:{'text-halo-color':'#fff','text-halo-width':1.2}});
  if(!map.getLayer('terr-label-pts')) map.addLayer({id:'terr-label-pts',type:'symbol',source:'terr-points',
    layout:{'text-field':['get','name'],'text-size':11,'text-offset':[0,1.0],'text-anchor':'top'},paint:{'text-halo-color':'#fff','text-halo-width':1.2}});
  if(!map.getLayer('b-outline')) map.addLayer({id:'b-outline',type:'line',source:'buildings',paint:{'line-color':'#9ca3af','line-width':1,'line-opacity':0.5}});

  const popup=e=>{const p=e.features[0].properties||{}; new maplibregl.Popup().setLngLat(e.lngLat)
    .setHTML(`<strong>${p.name||'Terras'}</strong><br>${e.features[0].state?.sunny?'ðŸŒž in de zon':'â›…ï¸Ž schaduw'}`).addTo(map);};
  map.on('click','terr-fill',popup); map.on('click','terr-points',popup);
}

/* ===== Zon per terras ===== */
function computeAndApplySun(){
  const bSun=document.getElementById('sunBadge'); const sp=sunPosition(STATE.date,AMS.lat,AMS.lon);
  const alt=sp.altitude, az=sp.azimuth; if(bSun) bSun.textContent=`Zon: alt ${alt.toFixed(1)}Â° â€¢ az ${Math.round(az)}Â°`;
  const sunnyFn=makeSunnyFn(alt,az,BUILDINGS);

  const setStateFor=(src,gj)=>{ if(!gj) return; gj.features.forEach(f=>{
    const isSunny=(alt>STATE.altThreshold)&&sunnyFn(f); map.setFeatureState({source:src,id:f.id},{sunny:isSunny}); });
  };
  setStateFor('terr-polys',TERR_POLY); setStateFor('terr-points',TERR_PTS);

  if(STATE.onlySunny){
    map.getSource('terr-polys').setData(filterSunny(TERR_POLY,'terr-polys'));
    map.getSource('terr-points').setData(filterSunny(TERR_PTS,'terr-points'));
  }else{
    map.getSource('terr-polys').setData(TERR_POLY);
    map.getSource('terr-points').setData(TERR_PTS);
  }
}

function filterSunny(gj, sourceId){
  if(!gj) return {type:'FeatureCollection',features:[]};
  const out={type:'FeatureCollection',features:[]};
  for(const f of gj.features){const st=map.getFeatureState({source:sourceId,id:f.id}); if(st&&st.sunny) out.features.push(f);}
  return out;
}

/* ===== Schaduw (simple) ===== */
function makeSunnyFn(altDeg, azDeg, buildings){
  const alt=altDeg*Math.PI/180, az=azDeg, tanAlt=Math.tan(alt), azMin=az-30, azMax=az+30;
  return function(terr){
    const center=turf.center(terr).geometry.coordinates;
    for(const b of (buildings.features||[])){
      const h=(b.properties&&Number.isFinite(b.properties.h_m))?b.properties.h_m:null;
      if(!h||h<=2) continue;
      const bc=turf.center(b).geometry.coordinates;
      const brg=turf.bearing(turf.point(center),turf.point(bc));
      const brg360=(brg+360)%360;
      if(!angleWithin(brg360,azMin,azMax)) continue;
      const dKm=turf.distance(center,bc); const d=dKm*1000; // meters
      const L=h/tanAlt; // schaduwlengte
      if(d <= L + 8){ return false; } // in schaduw
    }
    return true;
  };
}
function angleWithin(a,min,max){const norm=x=>(x%360+360)%360; const A=norm(a),MIN=norm(min),MAX=norm(max); return (MIN<=MAX)?(A>=MIN&&A<=MAX):(A>=MIN||A<=MAX);}

/* ===== UI ===== */
function setupControls(){
  const t=document.getElementById('time'), d=document.getElementById('date'),
        only=document.getElementById('onlySunny'), btnNow=document.getElementById('btnNow');
  const now=new Date(), pad=n=>String(n).padStart(2,'0');
  if(t) t.value='13:00';
  if(d) d.valueAsDate=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  STATE.date=new Date(now.getFullYear(),now.getMonth(),now.getDate(),13,0);

  function updateDT(){
    const [hh,mm]=(t.value||'13:00').split(':').map(n=>parseInt(n,10));
    const base=d.valueAsDate||new Date();
    STATE.date=new Date(base.getFullYear(),base.getMonth(),base.getDate(),hh,mm);
    computeAndApplySun();
  }
  if(t) t.addEventListener('input',updateDT);
  if(d) d.addEventListener('input',updateDT);
  if(only) only.addEventListener('change',()=>{STATE.onlySunny=!!only.checked; computeAndApplySun();});
  if(btnNow) btnNow.addEventListener('click',()=>{
    const n=new Date();
    if(t) t.value=`${pad(n.getHours())}:${pad(n.getMinutes()-n.getMinutes()%5)}`;
    if(d) d.valueAsDate=new Date(n.getFullYear(),n.getMonth(),n.getDate());
    STATE.date=n; computeAndApplySun();
  });
}
</script>
</body>
</html>
