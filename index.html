<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SunTerras — Amsterdam</title>
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html,body{height:100%;margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif}
    header{padding:10px 12px;border-bottom:1px solid #eee;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    #map{position:absolute;inset:60px 0 0 0}
    .badge{padding:4px 8px;border-radius:999px;background:#f5f5f5}
  </style>
</head>
<body>
<header>
  <strong>SunTerras — AMS</strong>
  <span class="badge" id="info">Laden…</span>
  <span class="badge" id="dataBadge">Data: ?</span>
</header>
<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script>
const map = new maplibregl.Map({
  container: 'map',
  style: { version: 8,
    sources: { osm: { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256, attribution: '© OpenStreetMap' } },
    layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
  },
  center: [4.895168, 52.370216], zoom: 13
});
map.addControl(new maplibregl.NavigationControl());

map.on('load', init);

async function init(){
  const info=document.getElementById('info');
  const badge=document.getElementById('dataBadge');

  try {
    const r = await fetch('/api/terraces'); // HAAL ALLES OP (GEEN BBOX)
    if (!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();

    const polys  = data.terracePolys || { type:'FeatureCollection', features:[] };
    const points = data.placePoints  || { type:'FeatureCollection', features:[] };

    // bronnen
    map.addSource('terr-polys',  { type:'geojson', data: polys  });
    map.addSource('terr-points', { type:'geojson', data: points });

    // lagen
    map.addLayer({ id:'terr-fill', type:'fill', source:'terr-polys',
      paint:{ 'fill-color':'#22c55e', 'fill-opacity':0.55 }});
    map.addLayer({ id:'terr-outline', type:'line', source:'terr-polys',
      paint:{ 'line-color':'#111', 'line-width':1 }});
    map.addLayer({ id:'terr-points', type:'circle', source:'terr-points',
      paint:{ 'circle-color':'#2563eb', 'circle-radius':6, 'circle-stroke-width':1, 'circle-stroke-color':'#111' }});
    map.addLayer({ id:'terr-label-polys', type:'symbol', source:'terr-polys',
      layout:{ 'text-field':['get','name'], 'text-size':11, 'text-offset':[0,1.0], 'text-anchor':'top' },
      paint:{ 'text-halo-color':'#fff', 'text-halo-width':1.2 }});
    map.addLayer({ id:'terr-label-pts', type:'symbol', source:'terr-points',
      layout:{ 'text-field':['get','name'], 'text-size':11, 'text-offset':[0,1.0], 'text-anchor':'top' },
      paint:{ 'text-halo-color':'#fff', 'text-halo-width':1.2 }});

    // popup
    const popup = (e) => {
      const p = e.features[0].properties || {};
      new maplibregl.Popup().setLngLat(e.lngLat)
        .setHTML(`<strong>${p.name || 'Terras'}</strong>`)
        .addTo(map);
    };
    map.on('click','terr-fill',popup);
    map.on('click','terr-points',popup);

    // badge + fit
    badge.textContent = `Data: REST • poly ${polys.features.length} • pt ${points.features.length}`;
    info.textContent = 'OK';
    fitTo(polys, points);
  } catch (e) {
    info.textContent = 'Terrassen laden mislukt';
    badge.textContent = 'Data: ?';
    console.error(e);
  }
}

function fitTo(polys, points){
  const ex=[Infinity,Infinity,-Infinity,-Infinity];
  const bump=([x,y])=>{ if(x<ex[0])ex[0]=x; if(y<ex[1])ex[1]=y; if(x>ex[2])ex[2]=x; if(y>ex[3])ex[3]=y; };
  (polys.features||[]).forEach(f=>{
    const rings = f.geometry.type==='Polygon' ? [f.geometry.coordinates] : f.geometry.coordinates;
    rings.forEach(poly=>poly[0].forEach(bump));
  });
  (points.features||[]).forEach(f=> bump(f.geometry.coordinates));
  if (isFinite(ex[0])) map.fitBounds([[ex[0],ex[1]],[ex[2],ex[3]]], { padding:60, duration:600 });
}
</script>
</body>
</html>
